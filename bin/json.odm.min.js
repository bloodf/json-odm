"use strict";function JsonOdm(){var n=this;this.sources={},this.selectedSource={},this.addSource=function(o,t,e){"object"==typeof t&&(void 0===n.sources[o]&&(n.sources[o]=t),e&&(n.selectedSource=t))},this.selectSource=function(o){void 0!==n.sources[o]&&(n.selectedSource=n.sources[o])}}var root="undefined"!=typeof window?window:global,jsonOdm=new JsonOdm;function createQueryStringModifier(o){return function(){return this.$modifyField((t=arguments,e=o,function(o){return"string"==typeof o&&String.prototype.hasOwnProperty(e)?String.prototype[e].apply(o,t):o}));var t,e}}root.jsonOdm||(root.jsonOdm=jsonOdm),"undefined"!=typeof module&&module.exports&&(jsonOdm.Collection=require("./collection"),jsonOdm.Geo=require("./geo"),jsonOdm.Query=require("./query"),jsonOdm.Util=require("./util"),module.exports=jsonOdm),(jsonOdm=void 0===jsonOdm?"undefined"==typeof module?new JsonOdm:global.jsonOdm:jsonOdm).Util=function(){},jsonOdm.Util.prototype.isArray=function(o){return Array.isArray?Array.isArray(o):"[object Array]"===Object.prototype.toString.call(o)},jsonOdm.Util.prototype.is=function(o,t){t="string"==typeof t?[t]:t;for(var e=(e=Object.prototype.toString.call(o)).substring(8,e.length-1).toLowerCase(),n=0;n<t.length;n++){var r=t[n].toLowerCase();if("array"===r&&this.isArray(o))return!0;if(r===e)return!0;if(typeof o===r)return!0}return!1},jsonOdm.Util.prototype.objectKeysPolyfill=function(){var r=Object.prototype.hasOwnProperty,i=!{toString:null}.propertyIsEnumerable("toString"),s=["toString","toLocaleString","valueOf","hasOwnProperty","isPrototypeOf","propertyIsEnumerable","constructor"],u=s.length;return function(o){if("object"!=typeof o&&("function"!=typeof o||null===o))throw new TypeError("Object.keys called on non-object");var t,e,n=[];for(t in o)r.call(o,t)&&n.push(t);if(i)for(e=0;e<u;e++)r.call(o,s[e])&&n.push(s[e]);return n}}(),jsonOdm.Util.prototype.objectKeys=Object.keys||jsonOdm.Util.prototype.objectKeysPolyfill,jsonOdm.Util.prototype.branch=function(o,t){function e(){var o;return arguments&&arguments.length&&this?(o=this[arguments[0]])&&e.apply(o,Array.prototype.slice.call(arguments,1)):this}return e.apply(o,t)},jsonOdm.Util.prototype.projectElement=function(o,t,e){var n,r={};for(n in o)o.hasOwnProperty(n)&&(1==o[n]?r[n]=t[n]:"function"==typeof o[n]?r[n]=o[n](e||t):o[n]instanceof jsonOdm.Query?(r[n]=o[n].$$commandQueue[o[n].$$commandQueue.length-1](t),!1!==o[n].$$accumulation&&(r[n]=o[n].$$accumulation)):"object"==typeof o[n]&&(r[n]=this.projectElement(o[n],t[n],e||t)));return r},jsonOdm.util=new jsonOdm.Util,"undefined"!=typeof module&&module.exports&&(module.exports=jsonOdm.Util),(jsonOdm=void 0===jsonOdm?"undefined"==typeof module?new JsonOdm:global.jsonOdm:jsonOdm).Geo=function(){},jsonOdm.Geo.detectAsGeometry=function(o){if(!o.type)if(jsonOdm.util.isArray(o)&&2===o.length&&!jsonOdm.util.isArray(o[0]))o=new jsonOdm.Geo.Point(o);else if(jsonOdm.util.isArray(o)&&4===o.length&&!jsonOdm.util.isArray(o[0]))o=new jsonOdm.Geo.BoundaryBox(o);else if(jsonOdm.util.isArray(o)&&1<=o.length&&jsonOdm.util.isArray(o[0])&&2===o[0].length&&!jsonOdm.util.isArray(o[0][0]))o=new jsonOdm.Geo.LineString(o);else if(jsonOdm.util.isArray(o)&&1<=o.length&&jsonOdm.util.isArray(o[0])&&1<=o[0].length&&jsonOdm.util.isArray(o[0][0])&&2===o[0][0].length&&!jsonOdm.util.isArray(o[0][0][0]))o=new jsonOdm.Geo.Polygon(o);else{if(!(jsonOdm.util.isArray(o)&&1<=o.length&&jsonOdm.util.isArray(o[0])&&1<=o[0].length&&jsonOdm.util.isArray(o[0][0])&&1<=o[0][0].length&&jsonOdm.util.isArray(o[0][0][0])&&2===o[0][0][0].length)||jsonOdm.util.isArray(o[0][0][0][0]))return!1;o=new jsonOdm.Geo.MultiPolygon(o)}return o},jsonOdm.Geo.FeatureCollection=function(o,t){this.type="FeatureCollection",this.features=o||[],t&&(this.bbox=t)},jsonOdm.Geo.Feature=function(o,t,e,n){this.geometry=o||{},t&&(this.properties=t),e&&(this.bbox=e),n&&(this.id=n)},jsonOdm.Geo.BoundaryBox=function(o){var t=Object.create(Array.prototype),t=Array.apply(t)||t;return jsonOdm.util.isArray(o)?(t[0]=o[0],t[1]=o[1],t[2]=o[2],t[3]=o[3]):(t[0]=0,t[1]=0,t[2]=0,t[3]=0),t},jsonOdm.Geo.BoundaryBox.within=function(o,t){return!(!jsonOdm.util.isArray(o)||4!==o.length)&&jsonOdm.Geo.Polygon.within(new jsonOdm.Geo.Polygon([[[o[0],o[1]],[o[2],o[1]],[o[2],o[3]],[o[0],o[3]],[o[0],o[1]]]]),t)},jsonOdm.Geo.Point=function(o,t){this.type="Point",this.coordinates=o,t&&(this.bbox=t)},jsonOdm.Geo.Point.within=function(o,t){var e,n;if(!o.coordinates)return!1;if("Point"===t.type)return t.coordinates[0]===o.coordinates[0]&&t.coordinates[1]===o.coordinates[1];if("MultiPoint"===t.type||"LineString"===t.type){for(e=0;t.coordinates&&e<t.coordinates.length;e++)if(t.coordinates[e][0]===o.coordinates[0]&&t.coordinates[e][1]===o.coordinates[1])return!0;return!1}if("MultiLineString"===t.type){for(e=0;t.coordinates&&e<t.coordinates.length;e++)for(n=0;t.coordinates[e]&&n<t.coordinates[e].length;n++)if(t.coordinates[e][n][0]===o.coordinates[0]&&t.coordinates[e][n][1]===o.coordinates[1])return!0;return!1}if("Polygon"===t.type)return jsonOdm.Geo.pointWithinPolygon(o.coordinates,t.coordinates?t.coordinates[0]:null);if("MultiPolygon"===t.type){for(e=0;t.coordinates&&e<t.coordinates.length;e++)if(jsonOdm.Geo.pointWithinPolygon(o.coordinates,t.coordinates[e]?t.coordinates[e][0]:null))return!0;return!1}if("GeometryCollection"===t.type&&jsonOdm.util.isArray(t.geometries)){for(e=0;e<t.geometries.length;e++)if(jsonOdm.Geo.Point.within(o,t.geometries[e]))return!0;return!1}return jsonOdm.Geo.pointWithinBounds(o.coordinates,t)},jsonOdm.Geo.Point.intersects=jsonOdm.Geo.Point.within,jsonOdm.Geo.MultiPoint=function(o,t){this.type="MultiPoint",this.coordinates=o,t&&(this.bbox=t)},jsonOdm.Geo.MultiPoint.within=function(o,t){var e,n,r,i;if(!o.coordinates||!jsonOdm.util.isArray(o.coordinates))return!1;if("Point"===t.type)return 1===o.coordinates.length&&o.coordinates[0][0]===t.coordinates[0]&&o.coordinates[0][1]===t.coordinates[1];if("MultiPoint"===t.type){for(n=0;o.coordinates&&n<o.coordinates.length;n++){for(i=!1,e=0;t.coordinates&&e<t.coordinates.length;e++)if(t.coordinates[e][0]===o.coordinates[n][0]&&t.coordinates[e][1]===o.coordinates[n][1]){i=!0;break}if(!i)return!1}return!0}if("LineString"===t.type){for(r=0;o.coordinates&&r<o.coordinates.length;r++)if(!jsonOdm.Geo.pointWithinLineString(o.coordinates[r],t.coordinates))return!1;return!0}if("MultiLineString"===t.type){for(r=0;o.coordinates&&r<o.coordinates.length;r++){for(i=!1,e=0;t.coordinates&&e<t.coordinates.length;e++)if(jsonOdm.Geo.pointWithinLineString(o.coordinates[r],t.coordinates[e])){i=!0;break}if(!i)return!1}return!0}if("Polygon"===t.type){for(e=0;o.coordinates&&e<o.coordinates.length;e++)if(!jsonOdm.Geo.pointWithinPolygon(o.coordinates[e],t.coordinates?t.coordinates[0]:null))return!1;return!0}if("MultiPolygon"===t.type){for(n=0;o.coordinates&&n<o.coordinates.length;n++){for(i=!1,e=0;t.coordinates&&e<t.coordinates.length;e++)if(jsonOdm.Geo.pointWithinPolygon(o.coordinates[n],t.coordinates[e]?t.coordinates[e][0]:null)){i=!0;break}if(!i)return!1}return!0}if("GeometryCollection"===t.type&&jsonOdm.util.isArray(t.geometries)){for(e=0;e<t.geometries.length;e++)if(jsonOdm.Geo.MultiPoint.within(o,t.geometries[e]))return!0;return!1}for(e=0;e<o.coordinates.length;e++)if(!jsonOdm.Geo.pointWithinBounds(o.coordinates[e],t))return!1;return!0},jsonOdm.Geo.MultiPoint.intersects=function(o,t){var e,n,r;if(!o.coordinates||!jsonOdm.util.isArray(o.coordinates))return!1;if("Point"===t.type)return jsonOdm.Geo.Point.intersects(t,o);if("MultiPoint"===t.type){for(n=0;o.coordinates&&n<o.coordinates.length;n++)for(e=0;t.coordinates&&e<t.coordinates.length;e++)if(t.coordinates[e][0]===o.coordinates[n][0]&&t.coordinates[e][1]===o.coordinates[n][1])return!0;return!1}if("LineString"===t.type){for(r=0;o.coordinates&&r<o.coordinates.length;r++)if(jsonOdm.Geo.pointWithinLineString(o.coordinates[r],t.coordinates))return!0;return!1}if("MultiLineString"===t.type){for(r=0;o.coordinates&&r<o.coordinates.length;r++)for(e=0;t.coordinates&&e<t.coordinates.length;e++)if(jsonOdm.Geo.pointWithinLineString(o.coordinates[r],t.coordinates[e]))return!0;return!1}if("Polygon"===t.type){for(e=0;o.coordinates&&e<o.coordinates.length;e++)if(jsonOdm.Geo.pointWithinPolygon(o.coordinates[e],t.coordinates?t.coordinates[0]:null))return!0;return!1}if("MultiPolygon"===t.type){for(n=0;o.coordinates&&n<o.coordinates.length;n++)for(e=0;t.coordinates&&e<t.coordinates.length;e++)if(jsonOdm.Geo.pointWithinPolygon(o.coordinates[n],t.coordinates[e]?t.coordinates[e][0]:null))return!0;return!1}if("GeometryCollection"===t.type&&jsonOdm.util.isArray(t.geometries)){for(e=0;e<t.geometries.length;e++)if(jsonOdm.Geo.MultiPoint.intersects(o,t.geometries[e]))return!0;return!1}for(e=0;e<o.coordinates.length;e++)if(jsonOdm.Geo.pointWithinBounds(o.coordinates[e],t))return!0;return!1},jsonOdm.Geo.LineString=function(o,t){this.type="LineString",this.coordinates=o,t&&(this.bbox=t)},jsonOdm.Geo.LineString.within=function(o,t){var e,n;if(!o.coordinates||!jsonOdm.util.isArray(o.coordinates))return!1;if("Point"===t.type||"MultiPoint"===t.type)return!1;if("LineString"===t.type)return jsonOdm.Geo.lineStringWithinLineString(o.coordinates,t.coordinates);if("MultiLineString"===t.type){for(e=0;t.coordinates&&e<t.coordinates.length;e++)if(jsonOdm.Geo.lineStringWithinLineString(o.coordinates,t.coordinates[e]))return!0;return!1}if("Polygon"===t.type){for(e=0;o.coordinates&&e<o.coordinates.length-1;e++)if(!jsonOdm.Geo.edgeWithinPolygon([o.coordinates[e],o.coordinates[e+1]],t.coordinates[0]))return!1;return!0}if("MultiPolygon"===t.type){for(e=0;t.coordinates&&e<t.coordinates.length;e++)for(n=0;o.coordinates&&n<o.coordinates.length-1;n++)if(jsonOdm.Geo.edgeWithinPolygon([o.coordinates[n],o.coordinates[n+1]],t.coordinates[e][0])&&n+1===o.coordinates.length-1)return!0;return!1}if("GeometryCollection"===t.type&&jsonOdm.util.isArray(t.geometries)){for(e=0;e<t.geometries.length;e++)if(jsonOdm.Geo.LineString.within(o,t.geometries[e]))return!0;return!1}for(e=0;e<o.coordinates.length;e++)if(!jsonOdm.Geo.pointWithinBounds(o.coordinates[e],t))return!1;return!0},jsonOdm.Geo.LineString.intersects=function(o,t){var e,n;if(!o.coordinates||!jsonOdm.util.isArray(o.coordinates))return!1;if("Point"===t.type)return jsonOdm.Geo.Point.intersects(t,o);if("MultiPoint"===t.type)return jsonOdm.Geo.MultiPoint.intersects(t,o);if("LineString"===t.type){for(e=0;e<o.coordinates.length-1;e++)if(jsonOdm.Geo.edgeIntersectsLineString([o.coordinates[e],o.coordinates[e+1]],t.coordinates))return!0;return!1}if("MultiLineString"===t.type){for(e=0;t.coordinates&&e<t.coordinates.length;e++)for(n=0;n<o.coordinates.length-1;n++)if(jsonOdm.Geo.edgeIntersectsLineString([o.coordinates[n],o.coordinates[n+1]],t.coordinates[e]))return!0;return!1}if("Polygon"===t.type){for(e=0;o.coordinates&&e<o.coordinates.length-1;e++)if(jsonOdm.Geo.edgeIntersectsPolygon([o.coordinates[e],o.coordinates[e+1]],t.coordinates[0]))return!0;return!1}if("MultiPolygon"===t.type){for(e=0;t.coordinates&&e<t.coordinates.length;e++)for(n=0;o.coordinates&&n<o.coordinates.length-1;n++)if(jsonOdm.Geo.edgeIntersectsPolygon([o.coordinates[n],o.coordinates[n+1]],t.coordinates[e][0]))return!0;return!1}if("GeometryCollection"===t.type&&jsonOdm.util.isArray(t.geometries)){for(e=0;e<t.geometries.length;e++)if(jsonOdm.Geo.LineString.intersects(o,t.geometries[e]))return!0;return!1}for(e=0;o.coordinates&&e<o.coordinates.length-1;e++)if(jsonOdm.Geo.edgeIntersectsBounds([o.coordinates[e],o.coordinates[e+1]],t))return!0;return!1},jsonOdm.Geo.MultiLineString=function(o,t){this.type="MultiLineString",this.coordinates=o,t&&(this.bbox=t)},jsonOdm.Geo.MultiLineString.within=function(o,t){var e,n,r,i;if(!o.coordinates||!jsonOdm.util.isArray(o.coordinates))return!1;if("Point"===t.type||"MultiPoint"===t.type)return!1;if("LineString"===t.type){for(e=0;o.coordinates&&e<o.coordinates.length;e++)if(!jsonOdm.Geo.lineStringWithinLineString(o.coordinates[e],t.coordinates))return!1;return!0}if("MultiLineString"===t.type){for(n=0;o.coordinates&&n<o.coordinates.length;n++){for(i=!1,e=0;t.coordinates&&e<t.coordinates.length;e++)if(jsonOdm.Geo.lineStringWithinLineString(o.coordinates[n],t.coordinates[e])){i=!0;break}if(!i)return!1}return!0}if("Polygon"===t.type){for(e=0;o.coordinates&&e<o.coordinates.length;e++)for(n=0;o.coordinates&&n<o.coordinates[e].length-1;n++)if(!jsonOdm.Geo.edgeWithinPolygon([o.coordinates[e][n],o.coordinates[e][n+1]],t.coordinates[0]))return!1;return!0}if("MultiPolygon"===t.type){for(n=0;o.coordinates&&n<o.coordinates.length;n++){for(i=!1,e=0;t.coordinates&&e<t.coordinates.length;e++)for(r=0;o.coordinates[n]&&r<o.coordinates[n].length-1;r++)if(jsonOdm.Geo.edgeWithinPolygon([o.coordinates[n][r],o.coordinates[n][r+1]],t.coordinates[e][0])&&r+1===o.coordinates[n].length-1){i=!0;break}if(!i)return!1}return!0}if("GeometryCollection"===t.type&&jsonOdm.util.isArray(t.geometries)){for(e=0;e<t.geometries.length;e++)if(jsonOdm.Geo.MultiLineString.within(o,t.geometries[e]))return!0;return!1}for(e=0;e<o.coordinates.length;e++)for(n=0;n<o.coordinates[e].length;n++)if(!jsonOdm.Geo.pointWithinBounds(o.coordinates[e][n],t))return!1;return!0},jsonOdm.Geo.MultiLineString.intersects=function(o,t){var e,n,r;if(!o.coordinates||!jsonOdm.util.isArray(o.coordinates))return!1;if("Point"===t.type)return jsonOdm.Geo.Point.intersects(t,o);if("MultiPoint"===t.type)return jsonOdm.Geo.MultiPoint.intersects(t,o);if("LineString"===t.type)return jsonOdm.Geo.LineString.intersects(t,o);if("MultiLineString"===t.type){for(n=0;o.coordinates&&n<o.coordinates.length;n++)for(r=0;o.coordinates[n]&&r<o.coordinates[n].length-1;r++)for(e=0;t.coordinates&&e<t.coordinates.length;e++)if(jsonOdm.Geo.edgeIntersectsLineString([o.coordinates[n][r],o.coordinates[n][r+1]],t.coordinates[e]))return!0;return!1}if("Polygon"===t.type){for(e=0;o.coordinates&&e<o.coordinates.length;e++)for(n=0;o.coordinates&&n<o.coordinates[e].length-1;n++)if(jsonOdm.Geo.edgeIntersectsPolygon([o.coordinates[e][n],o.coordinates[e][n+1]],t.coordinates[0]))return!0;return!1}if("MultiPolygon"===t.type){for(n=0;o.coordinates&&n<o.coordinates.length;n++)for(e=0;t.coordinates&&e<t.coordinates.length;e++)for(r=0;o.coordinates[n]&&r<o.coordinates[n].length-1;r++)if(jsonOdm.Geo.edgeIntersectsPolygon([o.coordinates[n][r],o.coordinates[n][r+1]],t.coordinates[e][0]))return!0;return!1}if("GeometryCollection"===t.type&&jsonOdm.util.isArray(t.geometries)){for(e=0;e<t.geometries.length;e++)if(jsonOdm.Geo.MultiLineString.intersects(o,t.geometries[e]))return!0;return!1}for(e=0;o.coordinates&&e<o.coordinates.length;e++)for(n=0;n<o.coordinates[e].length-1;n++)if(jsonOdm.Geo.edgeIntersectsBounds([o.coordinates[e][n],o.coordinates[e][n+1]],t))return!0;return!1},jsonOdm.Geo.Polygon=function(o,t){this.type="Polygon",this.coordinates=o,t&&(this.bbox=t)},jsonOdm.Geo.Polygon.within=function(o,t){var e,n;if(!o.coordinates||!jsonOdm.util.isArray(o.coordinates))return!1;if("Point"===t.type||"MultiPoint"===t.type||"LineString"===t.type||"MultiLineString"===t.type)return!1;if("Polygon"===t.type){for(e=0;o.coordinates[0]&&e<o.coordinates[0].length-1;e++)if(!jsonOdm.Geo.edgeWithinPolygon([o.coordinates[0][e],o.coordinates[0][e+1]],t.coordinates[0]))return!1;return!0}if("MultiPolygon"===t.type){for(e=0;t.coordinates&&e<t.coordinates.length;e++)for(n=0;o.coordinates[0]&&n<o.coordinates[0].length-1;n++){var r=jsonOdm.Geo.edgeWithinPolygon([o.coordinates[0][n],o.coordinates[0][n+1]],t.coordinates[e][0]);if(!r)break;if(r&&n+1===o.coordinates[0].length-1)return!0}return!1}if("GeometryCollection"===t.type&&jsonOdm.util.isArray(t.geometries)){for(e=0;e<t.geometries.length;e++)if(jsonOdm.Geo.Polygon.within(o,t.geometries[e]))return!0;return!1}for(e=0;o.coordinates[0]&&e<o.coordinates[0].length;e++)if(!jsonOdm.Geo.pointWithinBounds(o.coordinates[0][e],t))return!1;return!0},jsonOdm.Geo.Polygon.intersects=function(o,t){var e,n;if(!o.coordinates||!jsonOdm.util.isArray(o.coordinates))return!1;if("Point"===t.type)return jsonOdm.Geo.Point.intersects(t,o);if("MultiPoint"===t.type)return jsonOdm.Geo.MultiPoint.intersects(t,o);if("LineString"===t.type)return jsonOdm.Geo.LineString.intersects(t,o);if("MultiLineString"===t.type)return jsonOdm.Geo.MultiLineString.intersects(t,o);if("Polygon"===t.type){for(e=0;o.coordinates[0]&&e<o.coordinates[0].length-1;e++)if(jsonOdm.Geo.edgeIntersectsPolygon([o.coordinates[0][e],o.coordinates[0][e+1]],t.coordinates[0]))return!0;return!1}if("MultiPolygon"===t.type){for(e=0;t.coordinates&&e<t.coordinates.length;e++)for(n=0;o.coordinates[0]&&n<o.coordinates[0].length-1;n++)if(jsonOdm.Geo.edgeIntersectsPolygon([o.coordinates[0][n],o.coordinates[0][n+1]],t.coordinates[e][0]))return!0;return!1}if("GeometryCollection"===t.type&&jsonOdm.util.isArray(t.geometries)){for(e=0;e<t.geometries.length;e++)if(jsonOdm.Geo.Polygon.intersects(o,t.geometries[e]))return!0;return!1}for(e=0;o.coordinates[0]&&e<o.coordinates[0].length-1;e++)if(jsonOdm.Geo.edgeIntersectsBounds([o.coordinates[0][e],o.coordinates[0][e+1]],t))return!0;return!1},jsonOdm.Geo.MultiPolygon=function(o,t){this.type="MultiPolygon",this.coordinates=o,t&&(this.bbox=t)},jsonOdm.Geo.MultiPolygon.within=function(o,t){var e,n,r,i;if(!o.coordinates||!jsonOdm.util.isArray(o.coordinates))return!1;if("Point"===t.type||"MultiPoint"===t.type||"LineString"===t.type||"MultiLineString"===t.type)return!1;if("Polygon"===t.type){for(e=0;o.coordinates&&e<o.coordinates.length;e++)for(n=0;n<o.coordinates[e][0].length-1;n++)if(!jsonOdm.Geo.edgeWithinPolygon([o.coordinates[e][0][n],o.coordinates[e][0][n+1]],t.coordinates[0]))return!1;return!0}if("MultiPolygon"===t.type){for(e=0;o.coordinates&&e<o.coordinates.length;e++){for(i=!1,n=0;t.coordinates&&n<t.coordinates.length;n++)for(r=0;o.coordinates[e][0]&&r<o.coordinates[e][0].length-1;r++){var s=jsonOdm.Geo.edgeWithinPolygon([o.coordinates[e][0][r],o.coordinates[e][0][r+1]],t.coordinates[n][0]);if(!s)break;if(s&&r+1===o.coordinates[e][0].length-1){i=!0;break}}if(!i)return!1}return!0}if("GeometryCollection"===t.type&&jsonOdm.util.isArray(t.geometries)){for(e=0;e<t.geometries.length;e++)if(jsonOdm.Geo.MultiPolygon.within(o,t.geometries[e]))return!0;return!1}for(e=0;e<o.coordinates.length;e++)for(n=0;n<o.coordinates[e][0].length;n++)if(!jsonOdm.Geo.pointWithinBounds(o.coordinates[e][0][n],t))return!1;return!0},jsonOdm.Geo.MultiPolygon.intersects=function(o,t){var e,n,r;if(!o.coordinates||!jsonOdm.util.isArray(o.coordinates))return!1;if("Point"===t.type)return jsonOdm.Geo.Point.intersects(t,o);if("MultiPoint"===t.type)return jsonOdm.Geo.MultiPoint.intersects(t,o);if("LineString"===t.type)return jsonOdm.Geo.LineString.intersects(t,o);if("MultiLineString"===t.type)return jsonOdm.Geo.MultiLineString.intersects(t,o);if("Polygon"===t.type)return jsonOdm.Geo.Polygon.intersects(t,o);if("MultiPolygon"===t.type){for(e=0;o.coordinates&&e<o.coordinates.length;e++)for(n=0;t.coordinates&&n<t.coordinates.length;n++)for(r=0;o.coordinates[e][0]&&r<o.coordinates[e][0].length-1;r++)if(jsonOdm.Geo.pointWithinPolygon(o.coordinates[e][0][r],t.coordinates[n][0]))return!0;return!1}if("GeometryCollection"===t.type&&jsonOdm.util.isArray(t.geometries)){for(e=0;e<t.geometries.length;e++)if(jsonOdm.Geo.MultiPolygon.intersects(o,t.geometries[e]))return!0;return!1}for(e=0;e<o.coordinates.length;e++)for(n=0;n<o.coordinates[e][0].length-1;n++)if(jsonOdm.Geo.edgeIntersectsBounds([o.coordinates[e][0][n],o.coordinates[e][0][n+1]],t))return!0;return!1},jsonOdm.Geo.GeometryCollection=function(o,t){this.type="GeometryCollection",this.geometries=o,t&&(this.bbox=t)},jsonOdm.Geo.GeometryCollection.within=function(o,t){if(!jsonOdm.util.isArray(o.geometries)||!o.geometries.length||!t.type)return!1;for(var e=0;e<o.geometries.length;e++){if(!jsonOdm.Geo[o.geometries[e].type]||!jsonOdm.Geo[o.geometries[e].type].within)return!1;if(!jsonOdm.Geo[o.geometries[e].type].within(o.geometries[e],t))return!1}return!0},jsonOdm.Geo.GeometryCollection.intersects=function(o,t){if(!jsonOdm.util.isArray(o.geometries)||!o.geometries.length||!t.type)return!1;for(var e=0;e<o.geometries.length;e++)if(jsonOdm.Geo[o.geometries[e].type]&&jsonOdm.Geo[o.geometries[e].type].intersects&&jsonOdm.Geo[o.geometries[e].type].intersects(o.geometries[e],t))return!0;return!1},jsonOdm.Geo.pointWithinPolygon=function(o,t){if(!(jsonOdm.util.isArray(o)&&jsonOdm.util.isArray(t)&&2<t.length))return!1;var e,n=0;t[0][0]===t[t.length-1][0]&&t[0][1]===t[t.length-1][1]||(t=t.concat([t[0]]));for(var r=0;r<t.length-1;r++){if(t[r][0]===o[0]&&t[r][1]===o[1])return!0;if(!(t[r][0]<o[0]&&t[r+1][0]<o[0]||t[r][1]<o[1]&&t[r+1][1]<o[1]||t[r][1]>o[1]&&t[r+1][1]>o[1])){if((e=(t[r][0]-t[r+1][0])*((o[1]-t[r+1][1])/(t[r][1]-t[r+1][1]))+t[r+1][0])===o[0]&&o[1]<=Math.max(t[r][1],t[r+1][1])&&o[1]>=Math.min(t[r][1],t[r+1][1]))return!0;e>o[0]&&n++}}return n%2==1},jsonOdm.Geo.edgeWithinPolygon=function(o,t){if(!(jsonOdm.util.isArray(o)&&2===o.length&&jsonOdm.util.isArray(t)&&2<=t.length))return!1;if(t[0][0]===t[t.length-1][0]&&t[0][1]===t[t.length-1][1]||(t=t.concat([t[0]])),!jsonOdm.Geo.pointWithinPolygon(o[0],t)||!jsonOdm.Geo.pointWithinPolygon(o[1],t))return!1;for(var e=0;e<t.length-1;e++)if(jsonOdm.Geo.edgeIntersectsEdge(o,[t[e],t[e+1]],!1))return!1;return!0},jsonOdm.Geo.edgeIntersectsPolygon=function(o,t){if(!(jsonOdm.util.isArray(o)&&2===o.length&&jsonOdm.util.isArray(t)&&2<=t.length))return!1;if(t[0][0]===t[t.length-1][0]&&t[0][1]===t[t.length-1][1]||(t=t.concat([t[0]])),jsonOdm.Geo.pointWithinPolygon(o[0],t)||jsonOdm.Geo.pointWithinPolygon(o[1],t))return!0;for(var e=0;e<t.length-1;e++)if(jsonOdm.Geo.edgeIntersectsEdge(o,[t[e],t[e+1]]))return!0;return!1},jsonOdm.Geo.edgeIntersectsLineString=function(o,t){if(!jsonOdm.util.isArray(o)||2!==o.length||!jsonOdm.util.isArray(t))return!1;for(var e=0;e<t.length-1;e++)if(jsonOdm.Geo.edgeIntersectsEdge(o,[t[e],t[e+1]]))return!0;return!1},jsonOdm.Geo.edgeIntersectsEdge=function(o,t,e){e=void 0===e||e;var n=[o[1][0]-o[0][0],o[1][1]-o[0][1]],r=[Math.min(o[0][0],o[1][0]),Math.min(o[0][1],o[1][1]),Math.max(o[0][0],o[1][0]),Math.max(o[0][1],o[1][1])],i=[t[1][0]-t[0][0],t[1][1]-t[0][1]],s=[Math.min(t[0][0],t[1][0]),Math.min(t[0][1],t[1][1]),Math.max(t[0][0],t[1][0]),Math.max(t[0][1],t[1][1])];if(s[0]<r[0]&&s[2]<r[0]||s[1]<r[1]&&s[3]<r[1]||r[0]<s[0]&&r[2]<s[0]||r[1]<s[1]&&r[3]<s[1])return!1;if(i[0]*n[1]-n[0]*i[1]==0)return e&&o[0][1]+(t[0][0]-o[0][0])/n[0]*n[1]===t[0][1];t=(t[0][1]*i[0]+o[0][0]*i[1]-t[0][0]*i[1]-o[0][1]*i[0])/(n[1]*i[0]-n[0]*i[1]),i=o[0][0]+t*n[0],o=o[0][1]+t*n[1];return e?r[0]<=i&&i<=r[2]&&r[1]<=o&&o<=r[3]&&s[0]<=i&&i<=s[2]&&s[1]<=o&&o<=s[3]:r[0]<i&&i<r[2]&&r[1]<o&&o<r[3]&&s[0]<i&&i<s[2]&&s[1]<o&&o<s[3]},jsonOdm.Geo.pointWithinLineString=function(o,t){if(!(jsonOdm.util.isArray(o)&&jsonOdm.util.isArray(t)&&2<=t.length))return!1;for(var e=0;e<t.length-1;e++)if((o[0]>=t[e][0]&&o[0]<=t[e+1][0]&&t[e][0]<=t[e+1][0]||o[0]<=t[e][0]&&o[0]>=t[e+1][0]&&t[e][0]>=t[e+1][0])&&(o[1]>=t[e][1]&&o[1]<=t[e+1][1]&&t[e][1]<=t[e+1][1]||o[1]<=t[e][1]&&o[1]>=t[e+1][1]&&t[e][1]>=t[e+1][1])&&(t[e][0]===o[0]&&t[e][1]===o[1]||t[e+1][0]===o[0]&&t[e+1][1]===o[1]||t[e][1]-t[e+1][1]!=0&&(t[e][0]-t[e+1][0])*((o[1]-t[e+1][1])/(t[e][1]-t[e+1][1]))+t[e+1][0]===o[0]||t[e][0]-t[e+1][0]!=0&&(t[e][1]-t[e+1][1])*((o[0]-t[e+1][0])/(t[e][0]-t[e+1][0]))+t[e+1][1]===o[1]))return!0;return!1},jsonOdm.Geo.pointWithinBounds=function(o,t){return!(!jsonOdm.util.isArray(o)||!jsonOdm.util.isArray(t)||4!==t.length)&&(o[0]>=t[0]&&o[1]>=t[1]&&o[0]<=t[2]&&o[1]<=t[3])},jsonOdm.Geo.edgeIntersectsBounds=function(o,t){return!(!jsonOdm.util.isArray(o)||!jsonOdm.util.isArray(t)||4!==t.length)&&jsonOdm.Geo.edgeIntersectsPolygon(o,[[t[0],t[1]],[t[2],t[1]],[t[2],t[3]],[t[0],t[3]]])},jsonOdm.Geo.lineStringWithinLineString=function(o,t){if(!jsonOdm.util.isArray(o)||!jsonOdm.util.isArray(t))return!1;for(var e=0;o&&e<o.length;e++){for(var n=!1,r=0;t&&r<t.length;r++)if(o[e][0]===t[r][0]&&o[e][1]===t[r][1]){if(e+1===o.length)return!0;if(!(t[r+1]&&o[e+1][0]===t[r+1][0]&&o[e+1][1]===t[r+1][1]||o[e+1][0]===t[r][0]&&o[e+1][1]===t[r][1]||0<r&&o[e+1][0]===t[r-1][0]&&o[e+1][1]===t[r-1][1]))return!1;n=!0}if(!n)return!1}return!0},"undefined"!=typeof module&&module.exports&&(module.exports=jsonOdm.Geo),(jsonOdm=void 0===jsonOdm?"undefined"==typeof module?new JsonOdm:global.jsonOdm:jsonOdm).Collection=function(o){var t=Object.create(Array.prototype),t=Array.apply(t)||t;return void 0!==o&&jsonOdm.selectedSource&&jsonOdm.selectedSource[o]&&(t=t.concat(jsonOdm.selectedSource[o])),jsonOdm.Collection.decorate(t),t.$branch=function(){var o=jsonOdm.util.branch(t,arguments);return jsonOdm.Collection.decorate(o),o},t},jsonOdm.Collection.decorate=function(o){var l;l=o,jsonOdm.util.isArray(l)&&(l.$hasMany=function(o,t,e,n){"string"==typeof e&&(n=n||e);var r=e;"string"==typeof e&&jsonOdm.selectedSource&&jsonOdm.selectedSource[e]&&(r=jsonOdm.selectedSource[e]);for(var i=0;i<l.length;i++){var s=o;if(l[i].hasOwnProperty(o)&&(s=l[i][o]),void 0===l[i][n])for(var u=0;s.length&&u<s.length;u++){for(var d=null,c=0;c<r.length;c++)if(s[u]==r[c][t]){d=r[c];break}null!=d&&(l[i][n]||(l[i][n]=[]),l[i][n].push(d))}}},l.$hasOne=function(o,t,e,n){"string"==typeof e&&(n=n||e);var r=e;"string"==typeof e&&jsonOdm.selectedSource&&jsonOdm.selectedSource[e]&&(r=jsonOdm.selectedSource[e]);for(var i,s=0;s<l.length;s++)if(l[s].hasOwnProperty(o)&&(i=l[s][o]),void 0===l[s][n]){for(var u=null,d=0;d<r.length;d++)if(i==r[d][t]){u=r[d];break}null!=u&&(l[s][n]=u)}},l.$query=function(){return new jsonOdm.Query(l)})},"undefined"!=typeof module&&module.exports&&(module.exports=jsonOdm.Collection),(jsonOdm=void 0===jsonOdm?"undefined"==typeof module?new JsonOdm:global.jsonOdm:jsonOdm).Query=function(o){this.$$commandQueue=[],this.$$aggregationBeforeCollectQueue=[],this.$$aggregationResultQueue=[],this.$$collection=o||[],this.$$accumulation=!1},jsonOdm.Query.prototype.$delete=function(){if(this.$$commandQueue.length<1)return this;for(var o=0;o<this.$$collection.length;){for(var t=!0,e=0;e<this.$$commandQueue.length&&(t=t&&this.$$commandQueue[e](this.$$collection[o]));e++);t?this.$$collection.splice(o,1):o++}return this},jsonOdm.Query.prototype.$result=function(o,t){if(this.$$commandQueue.length<1&&this.$$aggregationBeforeCollectQueue<1)return this.$$collection;o=void 0===o?0:o,t=void 0===t?this.$$collection.length:t;for(var e,n=new jsonOdm.Collection,r=0;r<this.$$collection.length;r++){for(var i=!0,s=0;s<this.$$commandQueue.length;s++){var u=this.$$commandQueue[s](this.$$collection[r]);if(!(i=i&&null!==u&&!1!==u&&void 0!==u))break}if(i)if(0<o)o--;else{if(t<=0)return n;for(e=this.$$collection[r],s=0;s<this.$$aggregationBeforeCollectQueue.length;s++)e=this.$$aggregationBeforeCollectQueue[s](r,e);n.push(e),t--}}for(r=0;r<this.$$aggregationResultQueue.length;r++)n=this.$$aggregationResultQueue[r](n);return n},jsonOdm.Query.prototype.$all=function(){return this.$result()},jsonOdm.Query.prototype.$first=function(){return this.$result(0,1)[0]},jsonOdm.Query.prototype.$aggregateCollection=function(o,t,e){return"function"==typeof t&&(t=[t]),"function"==typeof e&&(e=[e]),jsonOdm.util.isArray(o="function"==typeof o?[o]:o)&&(this.$$commandQueue=this.$$commandQueue.concat(o)),jsonOdm.util.isArray(t)&&(this.$$aggregationBeforeCollectQueue=this.$$aggregationBeforeCollectQueue.concat(t)),jsonOdm.util.isArray(e)&&(this.$$aggregationResultQueue=this.$$aggregationResultQueue.concat(e)),this},jsonOdm.Query.prototype.$group=function(){var r,i,d,c,l,o=arguments,t=!1,e=[];return 1<arguments.length&&!jsonOdm.util.isArray(arguments[arguments.length-1])&&!jsonOdm.util.is(arguments[arguments.length-1],"string")&&"object"==typeof arguments[arguments.length-1]&&(t=arguments[arguments.length-1],o=Array.prototype.slice.call(arguments,0,arguments.length-1)),this.$aggregateCollection((d=o,l={},function(o){for(var t={},e=l,n=0;n<d.length;n++){var r=jsonOdm.util.isArray(d[n])?d[n]:[d[n]],i=jsonOdm.util.branch(o,r);n<d.length-1&&(void 0===e[""+i]&&(e[""+i]={}),e=e[""+i]);for(var s=t,u=0;u<r.length-1;u++)void 0===s[r[u]]&&(s[r[u]]={}),s=s[r[u]];s[r[r.length-1]]=i}return e[""+i]||(e[""+i]={accumulationObject:t,subResultSet:[]},c.push(e[""+i])),e[""+i].subResultSet.push(o),!0}),null,(r=c=e,i=t,function(){for(var o=new jsonOdm.Collection,t=0;t<r.length;t++)if(!1===i)o.push(r[t].accumulationObject);else{!function o(t){for(var e in t)t.hasOwnProperty(e)&&(t[e]instanceof jsonOdm.Query&&(t[e].$$accumulation=!1),"object"==typeof t[e]&&o(t[e]))}(i);for(var e={},n=0;n<r[t].subResultSet.length;n++)e=jsonOdm.util.projectElement(i,r[t].subResultSet[n]);for(n in r[t].accumulationObject)r[t].accumulationObject.hasOwnProperty(n)&&(e[n]=r[t].accumulationObject[n]);o.push(e)}return o}))},jsonOdm.Query.prototype.$project=function(e){return this.$aggregateCollection(null,function(o,t){return jsonOdm.util.projectElement(e,t)})},jsonOdm.Query.prototype.$testCollection=function(t,e){var n=this.$$commandQueue.pop();return this.$$commandQueue.push(function(o){if(!(n instanceof jsonOdm.Collection||"function"==typeof n||void 0===n)||"function"!=typeof e)return!1;o=void 0===n?o:n instanceof jsonOdm.Collection?n:n(o);return!!e(o,t)}),this},jsonOdm.Query.prototype.$queryOperator=function(o,t){function e(o){if("function"!=typeof i)return!1;for(var t=[],e=0;e<r.length;e++)if(r[e]instanceof jsonOdm.Query)for(var n=0;n<r[e].$$commandQueue.length;n++)t.push(r[e].$$commandQueue[n](o));else t.push(r[e]);return i(t)}r=o,i=t;var r,i,o=new jsonOdm.Query(this.$$collection);return o.$$commandQueue.push(e),o},jsonOdm.Query.prototype.$branch=function(o){if(void 0===o)return this;function t(o){return jsonOdm.util.branch(o,e)}e=arguments;var e,o=new jsonOdm.Query(this.$$collection);return o.$$commandQueue.push(t),o},jsonOdm.Query.prototype.$modifyField=function(o){function t(o){return o=null!==n?n(o):o,"function"==typeof e?e(o):o}var e,n;e=o,n=this.$$commandQueue.length?this.$$commandQueue[this.$$commandQueue.length-1]:null;return this.$$commandQueue.push(t),this},jsonOdm.Query.stringFiledModifyer=["charAt","charCodeAt","concat","fromCharCode","indexOf","lastIndexOf","localeCompare","match","replace","search","slice","split","substr","substring","toLocaleLowerCase","toLocaleUpperCase","toLowerCase","toUpperCase","trim","valueOf"];for(var i=0;i<jsonOdm.Query.stringFiledModifyer.length;i++)jsonOdm.Query.prototype["$"+jsonOdm.Query.stringFiledModifyer[i]]=createQueryStringModifier(jsonOdm.Query.stringFiledModifyer[i]);jsonOdm.Query.prototype.$accumulator=function(o,t){o="string"==typeof o?[o]:o;function e(o){var t=null!==n?jsonOdm.util.branch(o,n):n;return i.$$accumulation=r(t,i.$$accumulation,o),s.$$accumulation=i.$$accumulation,t}var n,r,i,s,u=new jsonOdm.Query(this.$$collection);n=o,r=t,s=this;return(i=u).$$commandQueue.push(e),u},jsonOdm.Query.prototype.$sum=function(o){return this.$accumulator(o,function(o,t){return o+(t=!1===t?0:t)})},jsonOdm.Query.prototype.$avg=function(o){var e,n;return this.$accumulator(o,function(o,t){return!1===t&&(n=e=0),(n+=o)/++e})},jsonOdm.Query.prototype.$max=function(o){return this.$accumulator(o,function(o,t){return!1===t&&(t=o),Math.max(o,t)})},jsonOdm.Query.prototype.$min=function(o){return this.$accumulator(o,function(o,t){return!1===t&&(t=o),Math.min(o,t)})},jsonOdm.Query.prototype.$count=function(){return this.$accumulator(null,function(o,t){return!1===t&&(t=0),++t})},jsonOdm.Query.prototype.$push=function(){var t,e,o=new jsonOdm.Query(this.$$collection);return e=this,(t=o).$$commandQueue.push(function(o){return t.$$accumulation=!1===t.$$accumulation?[]:t.$$accumulation,t.$$accumulation.push(o),e.$$accumulation=t.$$accumulation,!0}),o},jsonOdm.Query.prototype.$add=function(o,t){return this.$queryOperator(arguments,function(o){for(var t=0<o.length?o[0]:0,e=1;e<o.length;e++)t+=o[e];return t})},jsonOdm.Query.prototype.$subtract=function(o){return void 0===o?this:this.$queryOperator(arguments,function(o){for(var t=0<o.length?o[0]:0,e=1;e<o.length;e++)t-=o[e];return t})},jsonOdm.Query.prototype.$multiply=function(o){return void 0===o?this:this.$queryOperator(arguments,function(o){for(var t=0<o.length?o[0]:0,e=1;e<o.length;e++)t*=o[e];return t})},jsonOdm.Query.prototype.$divide=function(o){return void 0===o?this:this.$queryOperator(arguments,function(o){for(var t=0<o.length?o[0]:0,e=1;e<o.length;e++)t/=o[e];return t})},jsonOdm.Query.prototype.$modulo=function(o,t){return void 0===o?this:this.$queryOperator(arguments,function(o){for(var t=0<o.length?o[0]:0,e=1;e<o.length;e++)t%=o[e];return t})},jsonOdm.Query.prototype.$eq=function(o){return void 0===o?this:this.$testCollection(arguments,function(o,t){for(var e=0;e<t.length;e++)if(t[e]===o)return!0;return!1})},jsonOdm.Query.prototype.$in=function(o){return this.$testCollection(o=void 0===o?[]:o,function(o,t){for(var e=0;e<t.length;e++)if(t[e]===o)return!0;return!1})},jsonOdm.Query.prototype.$ne=function(o){return void 0===o?this:this.$testCollection(arguments,function(o,t){for(var e=0;e<t.length;e++)if(t[e]===o)return!1;return!0})},jsonOdm.Query.prototype.$nin=function(o){return this.$testCollection(o=void 0===o?[]:o,function(o,t){for(var e=0;e<t.length;e++)if(t[e]===o)return!1;return!0})},jsonOdm.Query.prototype.$gt=function(o){return this.$testCollection(o,function(o,t){return t<o})},jsonOdm.Query.prototype.$gte=function(o){return this.$testCollection(o,function(o,t){return t<=o})},jsonOdm.Query.prototype.$lt=function(o){return this.$testCollection(o,function(o,t){return o<t})},jsonOdm.Query.prototype.$lte=function(o){return this.$testCollection(o,function(o,t){return o<=t})},jsonOdm.Query.prototype.$isNull=function(){return this.$testCollection(null,function(o){return null==o})},jsonOdm.Query.prototype.$exists=function(){return this.$testCollection(null,function(o){return void 0!==o})},jsonOdm.Query.prototype.$type=function(o){return void 0===o?this.$testCollection([o],function(){return!1}):this.$testCollection(arguments,function(o,t){return jsonOdm.util.is(o,t)})},jsonOdm.Query.prototype.$mod=function(o,t){return void 0===o||void 0===t?this:this.$testCollection(arguments,function(o,t){return o%t[0]===t[1]})},jsonOdm.Query.prototype.$regex=function(o,t){return"string"==typeof o&&(o="string"==typeof t?new RegExp(o,t):new RegExp(o)),this.$testCollection(o,function(o,t){return t.test(o)})},jsonOdm.Query.prototype.$text=function(o){for(var t,e,n=/(^| )-([^ ]+)( |$)/g,r=/"([^"]+)"/g,i=[],s=[];null!==(t=n.exec(o));)i.push(t[2]);for(o=o.replace(n,"");null!==(e=r.exec(o));)s.push(e[1]);var u=(o=o.replace(r,"")).split(" ");return this.$testCollection([i,s,u],function(o,t){for(var e=0;e<t[0].length;e++)if(-1<o.indexOf(t[0][e]))return!1;for(e=0;e<t[1].length;e++)if(o.indexOf(t[1][e])<0)return!1;for(e=0;e<t[2].length;e++)if(-1<o.indexOf(t[2][e]))return!0;return!!t[1].length})},jsonOdm.Query.prototype.$where=function(o){return this.$testCollection(o,function(o,t){return"function"==typeof t&&t.apply(o)})},jsonOdm.Query.prototype.$geoWithin=function(o){return this.$testCollection(jsonOdm.Geo.detectAsGeometry(o),function(o,t){return jsonOdm.Geo[o.type]&&jsonOdm.Geo[o.type].within&&jsonOdm.Geo[o.type].within(o,t)})},jsonOdm.Query.prototype.$geoIntersects=function(o){return this.$testCollection(jsonOdm.Geo.detectAsGeometry(o),function(o,t){return jsonOdm.Geo[o.type]&&jsonOdm.Geo[o.type].intersects&&jsonOdm.Geo[o.type].intersects(o,t)})},jsonOdm.Query.prototype.$and=function(o){return this.$queryOperator(arguments,function(o){for(var t=0;t<o.length;t++)if(!o[t])return!1;return!0})},jsonOdm.Query.prototype.$nand=function(o){return this.$queryOperator(arguments,function(o){for(var t=0;t<o.length;t++)if(!o[t])return!0;return!1})},jsonOdm.Query.prototype.$not=jsonOdm.Query.prototype.$nand,jsonOdm.Query.prototype.$or=function(o){return this.$queryOperator(arguments,function(o){for(var t=0;t<o.length;t++)if(o[t])return!0;return!1})},jsonOdm.Query.prototype.$nor=function(o){return this.$queryOperator(arguments,function(o){for(var t=0;t<o.length;t++)if(o[t])return!1;return!0})},"undefined"!=typeof module&&module.exports&&(module.exports=jsonOdm.Query);